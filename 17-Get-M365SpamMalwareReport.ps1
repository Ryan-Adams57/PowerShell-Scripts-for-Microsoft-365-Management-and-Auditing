<#
====================================================================================
Script Name: 17-Get-M365SpamMalwareReport.ps1
Description: Production-ready M365 reporting script
Version: 2.0 - Production Ready
Last Updated: 2026-01-28
====================================================================================

REQUIREMENTS:
• PowerShell 5.1 or higher
• Appropriate M365 administrator permissions
• Required modules (will be validated at runtime)

====================================================================================
#>

#Requires -Version 5.1

[CmdletBinding()]

param(
    [Parameter(Mandatory=$false)]
    [datetime]$StartDate = (Get-Date).AddDays(-7),
    
    [Parameter(Mandatory=$false)]
    [datetime]$EndDate = (Get-Date),
    
    [Parameter(Mandatory=$false)]
    [ValidateSet("Spam","Malware","Phish","All")]
    [string]$ThreatType = "All",
    
    [Parameter(Mandatory=$false)]
    [string]$RecipientAddress,
    
    [Parameter(Mandatory=$false)]
    [string]$ExportPath = ".\M365_Spam_Malware_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# Module validation and installation
Write-Host "`n====================================================================================`n" -ForegroundColor Cyan
Write-Host "Microsoft 365 Spam and Malware Protection Report" -ForegroundColor Green
Write-Host "`n====================================================================================`n" -ForegroundColor Cyan

$requiredModule = "ExchangeOnlineManagement"

if (-not (Get-Module -ListAvailable -Name $requiredModule)) {
    Write-Host "Required module '$requiredModule' is not installed." -ForegroundColor Yellow
    $install = Read-Host "Would you like to install it now? (Y/N)"
    
    if ($install -eq 'Y' -or $install -eq 'y') {
        try {
            Write-Host "Installing $requiredModule..." -ForegroundColor Cyan
            Install-Module -Name $requiredModule -Scope CurrentUser -Repository PSGallery -Force -AllowClobber
            Write-Host "$requiredModule installed successfully.`n" -ForegroundColor Green
        }
        catch {
            Write-Host "Failed to install $requiredModule. Error: $_" -ForegroundColor Red
            exit
        }
    }
    else {
        Write-Host "Module installation declined. Script cannot continue." -ForegroundColor Red
        exit
    }
}

# Validate date range
$dateRangeDays = (New-TimeSpan -Start $StartDate -End $EndDate).Days

if ($dateRangeDays -gt 10) {
    Write-Host "WARNING: Large date ranges may take significant time to process." -ForegroundColor Yellow
    Write-Host "Consider reducing the date range for faster results.`n" -ForegroundColor Yellow
}

if ($StartDate -gt $EndDate) {
    Write-Host "ERROR: Start date cannot be after end date." -ForegroundColor Red
    exit
}

Write-Host "Search Parameters:" -ForegroundColor Cyan
Write-Host "  Start Date: $($StartDate.ToString('yyyy-MM-dd'))" -ForegroundColor White
Write-Host "  End Date: $($EndDate.ToString('yyyy-MM-dd'))`n" -ForegroundColor White

# Connect to Exchange Online
Write-Host "Connecting to Exchange Online..." -ForegroundColor Cyan

try {
    Connect-ExchangeOnline -ShowBanner:$false -UseRPSSession -ErrorAction Stop
    Write-Host "Successfully connected to Exchange Online.`n" -ForegroundColor Green
}
catch {
    Write-Host "Failed to connect to Exchange Online. Error: $_" -ForegroundColor Red
    exit
}

# Retrieve threat data
Write-Host "Retrieving spam and malware protection data..." -ForegroundColor Cyan
Write-Host "Note: Processing threat data from Exchange Online Protection...`n" -ForegroundColor Yellow

$results = @()
$spamCount = 0
$malwareCount = 0
$phishCount = 0

try {
    # Get quarantine messages
    Write-Host "Searching quarantined messages..." -ForegroundColor Cyan
    
    $quarantineParams = @{
        StartReceivedDate = $StartDate
        EndReceivedDate = $EndDate
        PageSize = 1000
    }
    
    if ($RecipientAddress) {
        $quarantineParams.Add("RecipientAddress", $RecipientAddress)
    }
    
    $quarantineMessages = Get-QuarantineMessage @quarantineParams
    
    Write-Host "Found $($quarantineMessages.Count) quarantined message(s). Processing...`n" -ForegroundColor Green
    
    $progressCounter = 0
    
    foreach ($message in $quarantineMessages) {
        $progressCounter++
        Write-Progress -Activity "Processing Quarantined Messages" -Status "Message $progressCounter of $($quarantineMessages.Count)" -PercentComplete (($progressCounter / $quarantineMessages.Count) * 100)
        
        # Determine threat type
        $threatCategory = "Unknown"
        if ($message.QuarantineTypes -contains "Spam") {
            $threatCategory = "Spam"
            $spamCount++
        }
        elseif ($message.QuarantineTypes -contains "Malware") {
            $threatCategory = "Malware"
            $malwareCount++
        }
        elseif ($message.QuarantineTypes -contains "Phish") {
            $threatCategory = "Phish"
            $phishCount++
        }
        elseif ($message.QuarantineTypes -contains "HighConfPhish") {
            $threatCategory = "High Confidence Phish"
            $phishCount++
        }
        
        # Filter by threat type
        if ($ThreatType -ne "All" -and $threatCategory -ne $ThreatType) {
            continue
        }
        
        $obj = [PSCustomObject]@{
            ReceivedTime = $message.ReceivedTime
            SenderAddress = $message.SenderAddress
            RecipientAddress = ($message.RecipientAddress -join "; ")
            Subject = $message.Subject
            ThreatCategory = $threatCategory
            QuarantineTypes = ($message.QuarantineTypes -join "; ")
            PolicyName = $message.PolicyName
            PolicyType = $message.PolicyType
            Direction = $message.Direction
            MessageSize = $message.Size
            Expires = $message.Expires
            Released = $message.Released
            ReleasedUser = $message.ReleasedUser
            MessageIdentity = $message.Identity
        }
        
        $results += $obj
    }
    
    Write-Progress -Activity "Processing Quarantined Messages" -Completed
}
catch {
    Write-Host "Error retrieving quarantine data: $_" -ForegroundColor Red
    Disconnect-ExchangeOnline -Confirm:$false | Out-Null
    exit
}

# Export and display results
if ($results.Count -gt 0) {
    Write-Host "`n====================================================================================`n" -ForegroundColor Cyan
    Write-Host "Threat Protection Summary:" -ForegroundColor Green
    Write-Host "  Total Quarantined Messages: $($results.Count)" -ForegroundColor White
    Write-Host "  Spam Messages: $spamCount" -ForegroundColor Yellow
    Write-Host "  Malware Messages: $malwareCount" -ForegroundColor Red
    Write-Host "  Phishing Messages: $phishCount" -ForegroundColor Red
    Write-Host "  Date Range: $($StartDate.ToString('yyyy-MM-dd')) to $($EndDate.ToString('yyyy-MM-dd'))" -ForegroundColor White
    
    # Top senders
    Write-Host "`n  Top 5 Blocked Senders:" -ForegroundColor Cyan
    $results | Group-Object SenderAddress | Sort-Object Count -Descending | Select-Object -First 5 | ForEach-Object {
        Write-Host "    $($_.Name): $($_.Count) messages" -ForegroundColor White
    }
    
    $results | Export-Csv -Path $ExportPath -NoTypeInformation -Encoding UTF8
    
    Write-Host "`n  Report Location: $ExportPath" -ForegroundColor White
    Write-Host "`n====================================================================================`n" -ForegroundColor Cyan
    
    # Display sample results
    Write-Host "Sample Results (First 10):" -ForegroundColor Yellow
    $results | Select-Object -First 10 | Format-Table ReceivedTime, SenderAddress, Subject, ThreatCategory -AutoSize
    
    $openFile = Read-Host "Would you like to open the CSV report? (Y/N)"
    if ($openFile -eq 'Y' -or $openFile -eq 'y') {
        Invoke-Item $ExportPath
    }
}
else {
    Write-Host "No quarantined messages found for the specified date range and criteria." -ForegroundColor Yellow
}

# Cleanup
Write-Host "Disconnecting from Exchange Online..." -ForegroundColor Cyan
Disconnect-ExchangeOnline -Confirm:$false | Out-Null
Write-Host "Script completed successfully.`n" -ForegroundColor Green
